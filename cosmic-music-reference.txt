// –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º—É–∑—ã–∫–∞ - –∑–∞–º–µ–Ω–∞ –¥–ª—è audio.js playBackgroundMusic()

// –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤–º–µ—Å—Ç–æ –º–µ—Ç–æ–¥–∞ playBackgroundMusic() –≤ audio.js

playBackgroundMusic() {
    if (!this.audioContext || this.musicOscillators.length > 0) return;

    try {
        // –°–æ–∑–¥–∞—ë–º –≥–ª–∞–≤–Ω—ã–π gain node –¥–ª—è –º—É–∑—ã–∫–∏
        this.musicGainNode = this.audioContext.createGain();
        this.musicGainNode.gain.value = this.musicVolume;
        this.musicGainNode.connect(this.audioContext.destination);

        // –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º—É–∑—ã–∫–∞ —Å –∞—Ä–ø–µ–¥–∂–∏–æ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫—É –¥–ª—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –∑–≤—É—á–∞–Ω–∏—è
        const pentatonicScale = [
            130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63
        ];

        // –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π –¥—Ä–æ–Ω (–Ω–∏–∑–∫–∏–π –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –≥—É–ª)
        const drone = this.audioContext.createOscillator();
        const droneGain = this.audioContext.createGain();
        const droneFilter = this.audioContext.createBiquadFilter();
        
        drone.type = 'sawtooth';
        drone.frequency.value = 65.41; // C2
        droneGain.gain.value = 0.15;
        droneFilter.type = 'lowpass';
        droneFilter.frequency.value = 200;
        
        drone.connect(droneFilter);
        droneFilter.connect(droneGain);
        droneGain.connect(this.musicGainNode);
        drone.start();
        
        this.musicOscillators.push({ oscillator: drone, gain: droneGain });

        // –°–æ–∑–¥–∞—ë–º –∞—Ä–ø–µ–¥–∂–∏–∞—Ç–æ—Ä (–∫–æ—Å–º–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–ª–∏–≤—ã)
        let arpIndex = 0;
        this.arpInterval = setInterval(() => {
            if (!this.musicEnabled) {
                clearInterval(this.arpInterval);
                return;
            }

            const freq = pentatonicScale[arpIndex % pentatonicScale.length];
            
            const osc = this.audioContext.createOscillator();
            const gain = this.audioContext.createGain();
            const filter = this.audioContext.createBiquadFilter();
            
            osc.type = 'sine';
            osc.frequency.value = freq;
            
            filter.type = 'lowpass';
            filter.frequency.value = 2000;
            filter.Q.value = 5;
            
            gain.gain.setValueAtTime(0.08, this.audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.8);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(this.musicGainNode);
            
            osc.start(this.audioContext.currentTime);
            osc.stop(this.audioContext.currentTime + 0.8);
            
            arpIndex++;
        }, 400); // –ö–∞–∂–¥—ã–µ 400–º—Å –Ω–æ–≤–∞—è –Ω–æ—Ç–∞

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –ø–∞–¥ (–º–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –∞–∫–∫–æ—Ä–¥—ã)
        const createPad = (freq, delay = 0) => {
            const osc = this.audioContext.createOscillator();
            const gain = this.audioContext.createGain();
            const filter = this.audioContext.createBiquadFilter();
            
            osc.type = 'triangle';
            osc.frequency.value = freq;
            
            filter.type = 'lowpass';
            filter.frequency.value = 800;
            
            const startTime = this.audioContext.currentTime + delay;
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(0.06, startTime + 2);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(this.musicGainNode);
            
            osc.start(startTime);
            
            this.musicOscillators.push({ oscillator: osc, gain: gain });
        };

        // –°–æ–∑–¥–∞—ë–º –ø–∞–¥-–∞–∫–∫–æ—Ä–¥
        createPad(261.63, 0);  // C4
        createPad(329.63, 0.5); // E4
        createPad(392.00, 1);   // G4

        this.musicEnabled = true;
        console.log('üéµ –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è –º—É–∑—ã–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞');
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º—É–∑—ã–∫–∏:', e);
    }
}
